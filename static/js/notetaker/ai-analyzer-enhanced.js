/**
 * Enhanced AI Analyzer with OpenAI Integration and Extended Presets
 * @module notetaker/ai-analyzer-enhanced
 */

import { Logger } from '../core/logger.js';
import { globalEvents } from '../core/events.js';
import { api } from '../core/api.js';

const logger = new Logger('NOTETAKER:AI-ENHANCED');

export class EnhancedAIAnalyzer {
    constructor(config = {}) {
        this.rolePreset = config.rolePreset || '';
        this.language = config.language || 'en-US';
        this.useOpenAI = config.useOpenAI || false;
        this.openAIKey = config.openAIKey || null;

        // Keyword patterns
        this.patterns = this.initializePatterns();

        // Extended role presets with color schemes
        this.roleConfigs = this.initializeRoleConfigs();

        // Custom color overrides (user can customize)
        this.customColors = config.customColors || null;

        logger.log('Enhanced AI Analyzer initialized', {
            role: this.rolePreset,
            language: this.language,
            useOpenAI: this.useOpenAI
        });
    }

    initializePatterns() {
        return {
            positive: [
                /\b(agree|yes|exactly|correct|great|excellent|perfect|love|amazing|wonderful|fantastic|awesome)\b/i,
                /\b(thank you|thanks|appreciate|helpful|good idea|sounds good|brilliant)\b/i,
                /\b(—É—Å–ø—ñ—à–Ω–æ|—á—É–¥–æ–≤–æ|–≤—ñ–¥–º—ñ–Ω–Ω–æ|–¥—è–∫—É—é|—Ç–∞–∫|–∑–≥–æ–¥–µ–Ω|–ø—Ä–∞–≤–∏–ª—å–Ω–æ|–∫–ª–∞—Å–Ω–æ)\b/i
            ],
            negative: [
                /\b(no|disagree|wrong|incorrect|bad|terrible|problem|issue|concern|worry|disappointed)\b/i,
                /\b(don't|can't|won't|shouldn't|impossible|difficult|hard|fail|failed)\b/i,
                /\b(–Ω—ñ|–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ|–ø–æ–≥–∞–Ω–æ|–ø—Ä–æ–±–ª–µ–º–∞|–Ω–µ –∑–≥–æ–¥–µ–Ω|–≤–∞–∂–∫–æ|–Ω–µ–≤–¥–∞—á–∞)\b/i
            ],
            question: [
                /\?$/,
                /\b(what|when|where|why|how|who|which|can you|could you|would you|should we)\b/i,
                /\b(—â–æ|–∫–æ–ª–∏|–¥–µ|—á–æ–º—É|—è–∫|—Ö—Ç–æ|—è–∫–∏–π|–º–æ–∂–Ω–∞|—á–∏|–º–æ–∂–µ–º–æ)\b/i
            ],
            action: [
                /\b(will|should|need to|have to|must|going to|let's|we'll|shall we)\b/i,
                /\b(action item|to-do|task|assignment|deadline|due date|deliverable)\b/i,
                /\b(—Ç—Ä–µ–±–∞|–ø–æ—Ç—Ä—ñ–±–Ω–æ|–∑—Ä–æ–±–∏–º–æ|–º–∞—î–º–æ|–±—É–¥–µ–º–æ|–¥–∞–≤–∞–π—Ç–µ|–¥–µ–¥–ª–∞–π–Ω)\b/i
            ],
            technical: [
                /\b(code|function|API|database|server|deploy|bug|error|debug|commit|pull request)\b/i,
                /\b(frontend|backend|infrastructure|architecture|performance|optimization)\b/i
            ],
            business: [
                /\b(revenue|profit|cost|budget|ROI|strategy|market|customer|client)\b/i,
                /\b(sales|marketing|product|growth|metrics|KPI|conversion|retention)\b/i
            ],
            learning: [
                /\b(learn|study|understand|explain|teach|example|practice|exercise)\b/i,
                /\b(quiz|test|homework|assignment|grade|progress|knowledge)\b/i
            ],
            emotional: [
                /\b(feel|feeling|emotion|stress|anxiety|happy|sad|frustrated|angry|excited)\b/i,
                /\b(–ø–æ—á—É–≤–∞—é—Å—è|–≤—ñ–¥—á—É–≤–∞—é|–µ–º–æ—Ü—ñ—è|–ø–µ—Ä–µ–∂–∏–≤–∞—é|—Ä–∞–¥–∏–π|—Å—É–º–Ω–∏–π|–∑–ª–∏–π)\b/i
            ],
            medical: [
                /\b(symptom|pain|medication|treatment|diagnosis|health|wellness|therapy)\b/i,
                /\b(—Å–∏–º–ø—Ç–æ–º|–±—ñ–ª—å|–ª—ñ–∫–∏|–ª—ñ–∫—É–≤–∞–Ω–Ω—è|–¥—ñ–∞–≥–Ω–æ–∑|–∑–¥–æ—Ä–æ–≤'—è|—Ç–µ—Ä–∞–ø—ñ—è)\b/i
            ]
        };
    }

    initializeRoleConfigs() {
        return {
            '': {
                name: 'üéØ General Meeting',
                description: 'General purpose meeting notes',
                focus: ['action', 'question'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#ef4444',
                    question: '#3b82f6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 1, negative: 1, question: 1, action: 2 }
            },
            'language-teacher': {
                name: 'üìö Language Teacher',
                description: 'Language learning and teaching sessions',
                focus: ['learning', 'question'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#ef4444',
                    question: '#8b5cf6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 1, negative: 2, question: 2, action: 1 },
                customPatterns: {
                    grammar: /\b(grammar|tense|article|verb|noun|–ø–æ–º–∏–ª–∫–∞|–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)\b/i,
                    vocabulary: /\b(word|vocabulary|meaning|definition|—Å–ª–æ–≤–æ|–∑–Ω–∞—á–µ–Ω–Ω—è)\b/i,
                    pronunciation: /\b(pronounce|pronunciation|accent|sound|–≤–∏–º–æ–≤–∞)\b/i
                }
            },
            'therapist': {
                name: 'üß† Therapist / Psychologist',
                description: 'Therapy and counseling sessions',
                focus: ['emotional', 'negative', 'positive'],
                aiComments: true,
                colors: {
                    positive: '#06b6d4',
                    negative: '#f43f5e',
                    question: '#8b5cf6',
                    action: '#10b981',
                    neutral: '#64748b'
                },
                sentimentWeights: { positive: 2, negative: 2, question: 1, action: 1 },
                customPatterns: {
                    breakthrough: /\b(realize|understand now|makes sense|clarity|epiphany|—É—Å–≤—ñ–¥–æ–º–ª—é—é|—Ä–æ–∑—É–º—ñ—é)\b/i,
                    resistance: /\b(but|however|though|still|not sure|–∞–ª–µ|–ø—Ä–æ—Ç–µ|–Ω–µ –≤–ø–µ–≤–Ω–µ–Ω–∏–π)\b/i,
                    emotion: /\b(feel|feeling|emotion|anxiety|stress|depression|–ø–æ—á—É–≤–∞—é—Å—è|–µ–º–æ—Ü—ñ—è|—Ç—Ä–∏–≤–æ–≥–∞|–¥–µ–ø—Ä–µ—Å—ñ—è)\b/i
                }
            },
            'business-coach': {
                name: 'üíº Business Coach',
                description: 'Business coaching and strategy',
                focus: ['business', 'action'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#ef4444',
                    question: '#3b82f6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 1, negative: 1, question: 1, action: 3 },
                customPatterns: {
                    goal: /\b(goal|target|objective|aim|achieve|KPI|—Ü—ñ–ª—å|–º–µ—Ç–∞|–¥–æ—Å—è–≥—Ç–∏)\b/i,
                    obstacle: /\b(challenge|obstacle|barrier|difficulty|risk|–ø–µ—Ä–µ—à–∫–æ–¥–∞|–ø—Ä–æ–±–ª–µ–º–∞|—Ä–∏–∑–∏–∫)\b/i,
                    metrics: /\b(revenue|profit|ROI|growth|conversion|–¥–æ—Ö—ñ–¥|–ø—Ä–∏–±—É—Ç–æ–∫|–∑—Ä–æ—Å—Ç–∞–Ω–Ω—è)\b/i
                }
            },
            'medical-consultant': {
                name: '‚öïÔ∏è Medical Consultant',
                description: 'Medical consultations and health discussions',
                focus: ['medical', 'question'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#dc2626',
                    question: '#3b82f6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 1, negative: 2, question: 2, action: 2 },
                customPatterns: {
                    symptom: /\b(hurt|pain|ache|discomfort|symptom|fever|–±–æ–ª–∏—Ç—å|–±—ñ–ª—å|—Å–∏–º–ø—Ç–æ–º|—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞)\b/i,
                    improvement: /\b(better|improving|healing|recovered|worse|–∫—Ä–∞—â–µ|–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è|–≥—ñ—Ä—à–µ)\b/i,
                    medication: /\b(medication|treatment|prescription|dose|–ª—ñ–∫–∏|–ª—ñ–∫—É–≤–∞–Ω–Ω—è|–¥–æ–∑–∞)\b/i
                }
            },
            'tutor': {
                name: 'üéì Academic Tutor',
                description: 'Tutoring and academic help',
                focus: ['learning', 'question'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#ef4444',
                    question: '#8b5cf6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 1, negative: 1, question: 2, action: 1 },
                customPatterns: {
                    understanding: /\b(understand|get it|makes sense|clear|—Ä–æ–∑—É–º—ñ—é|–∑—Ä–æ–∑—É–º—ñ–ª–æ)\b/i,
                    confusion: /\b(confused|don't understand|unclear|lost|–Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–æ|–∑–∞–ø–ª—É—Ç–∞–≤—Å—è)\b/i,
                    concept: /\b(concept|theory|principle|formula|–∫–æ–Ω—Ü–µ–ø—Ü—ñ—è|—Ç–µ–æ—Ä—ñ—è|—Ñ–æ—Ä–º—É–ª–∞)\b/i
                }
            },
            'sales-training': {
                name: 'üìà Sales Training',
                description: 'Sales calls and training',
                focus: ['business', 'action', 'question'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#ef4444',
                    question: '#3b82f6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 2, negative: 1, question: 2, action: 3 },
                customPatterns: {
                    objection: /\b(but|however|concern|worried|expensive|too much|–∞–ª–µ|–¥–æ—Ä–æ–≥–æ|–∑–∞–Ω–∞–¥—Ç–æ)\b/i,
                    buying_signal: /\b(interested|love it|perfect|when can|how soon|–∫–æ–ª–∏ –º–æ–∂–Ω–∞|—Ü—ñ–∫–∞–≤–æ)\b/i,
                    closing: /\b(deal|contract|sign|purchase|buy|—É–≥–æ–¥–∞|–ø—ñ–¥–ø–∏—Å–∞—Ç–∏|–∫—É–ø–∏—Ç–∏)\b/i
                }
            },
            'interview': {
                name: 'üé§ Job Interview',
                description: 'Job interviews and candidate assessment',
                focus: ['question', 'technical', 'business'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#ef4444',
                    question: '#3b82f6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 1, negative: 1, question: 2, action: 1 },
                customPatterns: {
                    experience: /\b(experience|worked on|responsible for|led|managed|–¥–æ—Å–≤—ñ–¥|–ø—Ä–∞—Ü—é–≤–∞–≤|–≤—ñ–¥–ø–æ–≤—ñ–¥–∞–≤)\b/i,
                    skills: /\b(skill|proficient|expert|familiar with|–∑–Ω–∞–Ω–Ω—è|–Ω–∞–≤–∏—á–∫–∏|–≤–º—ñ—é)\b/i,
                    achievement: /\b(achieved|accomplished|delivered|improved|–¥–æ—Å—è–≥–Ω—É–≤|–ø–æ–∫—Ä–∞—â–∏–≤)\b/i
                }
            },
            'legal-consultation': {
                name: '‚öñÔ∏è Legal Consultation',
                description: 'Legal advice and consultations',
                focus: ['question', 'action'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#dc2626',
                    question: '#3b82f6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 1, negative: 2, question: 2, action: 2 },
                customPatterns: {
                    legal_term: /\b(contract|agreement|clause|liability|lawsuit|–ø—Ä–∞–≤–∞|–¥–æ–≥–æ–≤—ñ—Ä|–ø–æ–∑–æ–≤)\b/i,
                    concern: /\b(worried|risk|illegal|violation|liable|—Ä–∏–∑–∏–∫|–Ω–µ–∑–∞–∫–æ–Ω–Ω–æ|–ø–æ—Ä—É—à–µ–Ω–Ω—è)\b/i,
                    deadline: /\b(file|submit|deadline|court date|–ø–æ–¥–∞—Ç–∏|—Ç–µ—Ä–º—ñ–Ω|—Å—É–¥)\b/i
                }
            },
            'brainstorming': {
                name: 'üí° Creative Brainstorming',
                description: 'Creative ideation and brainstorming',
                focus: ['positive', 'action'],
                aiComments: true,
                colors: {
                    positive: '#8b5cf6',
                    negative: '#6b7280',
                    question: '#3b82f6',
                    action: '#f59e0b',
                    neutral: '#64748b'
                },
                sentimentWeights: { positive: 2, negative: 0, question: 1, action: 2 },
                customPatterns: {
                    idea: /\b(idea|concept|what if|imagine|think about|—ñ–¥–µ—è|–∫–æ–Ω—Ü–µ–ø—Ü—ñ—è|—É—è–≤—ñ—Ç—å)\b/i,
                    innovation: /\b(innovative|creative|unique|new approach|fresh|—ñ–Ω–Ω–æ–≤–∞—Ü—ñ–π–Ω–æ|–∫—Ä–µ–∞—Ç–∏–≤–Ω–æ|—Å–≤—ñ–∂–µ)\b/i,
                    build_on: /\b(and also|building on|expanding|plus|—ñ —Ç–∞–∫–æ–∂|—Ä–æ–∑–≤–∏–≤–∞—é—á–∏)\b/i
                }
            },
            'project-planning': {
                name: 'üìã Project Planning',
                description: 'Project planning and management',
                focus: ['action', 'technical'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#ef4444',
                    question: '#3b82f6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 1, negative: 1, question: 1, action: 3 },
                customPatterns: {
                    milestone: /\b(milestone|deadline|deliverable|sprint|release|–≤—ñ—Ö–∞|—Ç–µ—Ä–º—ñ–Ω|—Å–ø—Ä–∏–Ω—Ç|—Ä–µ–ª—ñ–∑)\b/i,
                    resource: /\b(resource|team|budget|allocation|hiring|—Ä–µ—Å—É—Ä—Å|–∫–æ–º–∞–Ω–¥–∞|–±—é–¥–∂–µ—Ç)\b/i,
                    risk: /\b(risk|blocker|dependency|bottleneck|—Ä–∏–∑–∏–∫|–±–ª–æ–∫–µ—Ä|–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å)\b/i
                }
            },
            'customer-support': {
                name: 'üõü Customer Support',
                description: 'Customer support and issue resolution',
                focus: ['question', 'negative', 'action'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#ef4444',
                    question: '#3b82f6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 1, negative: 2, question: 2, action: 2 },
                customPatterns: {
                    issue: /\b(problem|issue|error|bug|not working|broken|–ø—Ä–æ–±–ª–µ–º–∞|–ø–æ–º–∏–ª–∫–∞|–Ω–µ –ø—Ä–∞—Ü—é—î)\b/i,
                    solution: /\b(fix|solve|resolve|workaround|patch|–≤–∏–ø—Ä–∞–≤–∏—Ç–∏|–≤–∏—Ä—ñ—à–∏—Ç–∏)\b/i,
                    escalation: /\b(urgent|critical|asap|immediately|priority|—Ç–µ—Ä–º—ñ–Ω–æ–≤–æ|–∫—Ä–∏—Ç–∏—á–Ω–æ)\b/i
                }
            },
            'performance-review': {
                name: 'üìä Performance Review',
                description: 'Employee performance reviews',
                focus: ['positive', 'negative', 'action'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#f59e0b',
                    question: '#3b82f6',
                    action: '#8b5cf6',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 2, negative: 1, question: 1, action: 2 },
                customPatterns: {
                    achievement: /\b(achieved|accomplished|exceeded|delivered|improved|–¥–æ—Å—è–≥–Ω—É–≤|–ø–µ—Ä–µ–≤–∏–∫–æ–Ω–∞–≤)\b/i,
                    improvement: /\b(improve|develop|grow|area for growth|enhance|–ø–æ–∫—Ä–∞—â–∏—Ç–∏|—Ä–æ–∑–≤–∏–Ω—É—Ç–∏)\b/i,
                    goal: /\b(goal|objective|target|next quarter|plan|—Ü—ñ–ª—å|–Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫–≤–∞—Ä—Ç–∞–ª)\b/i
                }
            },
            'investor-pitch': {
                name: 'üí∞ Investor Pitch',
                description: 'Investor pitches and funding discussions',
                focus: ['business', 'action'],
                aiComments: true,
                colors: {
                    positive: '#10b981',
                    negative: '#ef4444',
                    question: '#3b82f6',
                    action: '#f59e0b',
                    neutral: '#6b7280'
                },
                sentimentWeights: { positive: 2, negative: 1, question: 2, action: 2 },
                customPatterns: {
                    traction: /\b(revenue|users|growth|traction|MRR|ARR|–¥–æ—Ö—ñ–¥|–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ|–∑—Ä–æ—Å—Ç–∞–Ω–Ω—è)\b/i,
                    market: /\b(market size|TAM|SAM|competition|—Ä–∏–Ω–æ–∫|–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü—ñ—è)\b/i,
                    funding: /\b(raise|funding|investment|valuation|round|—ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ—è|—Ä–∞—É–Ω–¥)\b/i
                }
            }
        };
    }

    /**
     * Analyze text - uses local patterns + optional OpenAI
     */
    async analyze(text, speaker = 'Unknown') {
        if (!text || text.trim().length === 0) {
            return null;
        }

        // Local analysis (always runs)
        const localAnalysis = this.analyzeLocal(text);

        // If OpenAI is enabled, enhance with GPT analysis
        if (this.useOpenAI && this.openAIKey) {
            try {
                const openAIAnalysis = await this.analyzeWithOpenAI(text, speaker, localAnalysis);
                return { ...localAnalysis, ...openAIAnalysis, source: 'openai' };
            } catch (error) {
                logger.warn('OpenAI analysis failed, using local:', error.message);
                return { ...localAnalysis, source: 'local' };
            }
        }

        return { ...localAnalysis, source: 'local' };
    }

    /**
     * Local pattern-based analysis
     */
    analyzeLocal(text) {
        const sentiment = this.detectSentiment(text);
        const keywords = this.extractKeywords(text);
        const aiComment = this.generateAIComment(text, sentiment, keywords);
        const categories = this.detectCategories(text);
        const color = this.getColorForSentiment(sentiment);

        return {
            sentiment,
            keywords,
            aiComment,
            categories,
            color,
            confidence: this.calculateConfidence(text, sentiment, keywords)
        };
    }

    /**
     * Analyze with OpenAI GPT
     */
    async analyzeWithOpenAI(text, speaker, localAnalysis) {
        const roleConfig = this.roleConfigs[this.rolePreset];

        const prompt = `You are analyzing a conversation transcript for a ${roleConfig.name} session.

Role context: ${roleConfig.description}
Speaker: ${speaker}
Text: "${text}"

Based on this text, provide:
1. Sentiment (positive/negative/question/action/neutral)
2. Key insights or observations
3. Suggested action items or follow-ups
4. Important keywords (max 5)

Respond in JSON format:
{
    "sentiment": "...",
    "aiInsight": "...",
    "actionItems": ["..."],
    "keywords": ["..."]
}`;

        try {
            const response = await api.post('/api/openai/analyze', {
                prompt,
                text,
                rolePreset: this.rolePreset
            });

            if (response.success && response.analysis) {
                return {
                    sentiment: response.analysis.sentiment || localAnalysis.sentiment,
                    aiInsight: response.analysis.aiInsight,
                    actionItems: response.analysis.actionItems || [],
                    keywords: [...new Set([...localAnalysis.keywords, ...(response.analysis.keywords || [])])],
                    openAIComment: response.analysis.aiInsight
                };
            }

            return {};

        } catch (error) {
            logger.error('OpenAI API error:', error);
            throw error;
        }
    }

    /**
     * Get color for sentiment based on current preset
     */
    getColorForSentiment(sentiment) {
        // Custom colors override preset colors
        if (this.customColors && this.customColors[sentiment]) {
            return this.customColors[sentiment];
        }

        const roleConfig = this.roleConfigs[this.rolePreset];
        return roleConfig?.colors?.[sentiment] || '#6b7280';
    }

    /**
     * Set custom colors
     */
    setCustomColors(colors) {
        this.customColors = colors;
        globalEvents.emit('ai-analyzer:colors-updated', colors);
    }

    /**
     * Get current color scheme
     */
    getColorScheme() {
        const roleConfig = this.roleConfigs[this.rolePreset];
        return this.customColors || roleConfig?.colors || {};
    }

    /**
     * Detect sentiment (same as before)
     */
    detectSentiment(text) {
        const scores = { positive: 0, negative: 0, question: 0, action: 0, neutral: 0 };

        for (const [sentiment, patterns] of Object.entries(this.patterns)) {
            if (['positive', 'negative', 'question', 'action'].includes(sentiment)) {
                for (const pattern of patterns) {
                    if (pattern.test(text)) {
                        const roleConfig = this.roleConfigs[this.rolePreset];
                        const weight = roleConfig?.sentimentWeights?.[sentiment] || 1;
                        scores[sentiment] += weight;
                    }
                }
            }
        }

        const roleConfig = this.roleConfigs[this.rolePreset];
        if (roleConfig?.customPatterns) {
            for (const [category, pattern] of Object.entries(roleConfig.customPatterns)) {
                if (pattern.test(text)) {
                    if (category.includes('error') || category.includes('obstacle') || category.includes('issue')) {
                        scores.negative += 2;
                    } else if (category.includes('understanding') || category.includes('improvement') || category.includes('achievement')) {
                        scores.positive += 2;
                    }
                }
            }
        }

        const maxScore = Math.max(...Object.values(scores));
        if (maxScore === 0) return 'neutral';

        return Object.entries(scores).reduce((a, b) => scores[a[0]] > scores[b[0]] ? a : b)[0];
    }

    extractKeywords(text) {
        const keywords = new Set();

        for (const [category, patterns] of Object.entries(this.patterns)) {
            for (const pattern of patterns) {
                const matches = text.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        if (match.length > 3) keywords.add(match.toLowerCase());
                    });
                }
            }
        }

        const roleConfig = this.roleConfigs[this.rolePreset];
        if (roleConfig?.customPatterns) {
            for (const pattern of Object.values(roleConfig.customPatterns)) {
                const matches = text.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        if (match.length > 3) keywords.add(match.toLowerCase());
                    });
                }
            }
        }

        return Array.from(keywords).slice(0, 10);
    }

    detectCategories(text) {
        const categories = [];
        const categoryPatterns = {
            technical: this.patterns.technical,
            business: this.patterns.business,
            learning: this.patterns.learning,
            emotional: this.patterns.emotional,
            medical: this.patterns.medical
        };

        for (const [category, patterns] of Object.entries(categoryPatterns)) {
            for (const pattern of patterns) {
                if (pattern.test(text)) {
                    categories.push(category);
                    break;
                }
            }
        }

        return categories;
    }

    generateAIComment(text, sentiment, keywords) {
        const roleConfig = this.roleConfigs[this.rolePreset];
        if (!roleConfig?.aiComments) return null;

        // Simple rule-based comments
        if (sentiment === 'action') return '‚ö° Action item identified';
        if (sentiment === 'question') return '‚ùì Question to address';
        if (keywords.some(k => k.includes('deadline') || k.includes('urgent'))) return '‚è∞ Time-sensitive';

        return null;
    }

    calculateConfidence(text, sentiment, keywords) {
        let confidence = 0.5;
        if (text.length > 50) confidence += 0.1;
        if (text.length > 100) confidence += 0.1;
        if (keywords.length > 0) confidence += 0.1;
        if (keywords.length > 2) confidence += 0.1;
        if (sentiment !== 'neutral') confidence += 0.1;
        return Math.min(confidence, 1.0);
    }

    setRolePreset(rolePreset) {
        this.rolePreset = rolePreset;
        logger.log(`Role preset changed to: ${rolePreset}`);
        globalEvents.emit('ai-analyzer:role-changed', rolePreset);
    }

    setLanguage(language) {
        this.language = language;
    }

    enableOpenAI(apiKey) {
        this.useOpenAI = true;
        this.openAIKey = apiKey;
        logger.log('OpenAI integration enabled');
    }

    disableOpenAI() {
        this.useOpenAI = false;
        this.openAIKey = null;
        logger.log('OpenAI integration disabled');
    }

    getRolePresets() {
        return Object.entries(this.roleConfigs).map(([id, config]) => ({
            id,
            name: config.name,
            description: config.description,
            focus: config.focus,
            colors: config.colors
        }));
    }
}

export default EnhancedAIAnalyzer;
