<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <title>Join Meeting - Kaminskyi AI Messenger</title>
    <link rel="stylesheet" href="/static/guest.css">
</head>
<body>
    <div class="guest-container">
        <div class="guest-card">
            <div class="logo">
                <div class="logo-icon">K</div>
            </div>

            <h1>Join Meeting</h1>
            <p class="host-name">Hosted by <span id="hostName">Oleh Kaminskyi</span></p>

            <!-- Step 1: Name and Language -->
            <form id="guestForm" style="display: block;">
                <div class="input-group">
                    <label for="guestName">Your Name / –í–∞—à–µ —ñ–º'—è</label>
                    <input type="text" id="guestName" name="guestName" placeholder="Enter your name" required autocomplete="name">
                </div>

                <div class="input-group">
                    <label for="languageSelect">Language / –ú–æ–≤–∞</label>
                    <select id="languageSelect" class="language-select">
                        <option value="uk">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                        <option value="en">üá¨üáß English</option>
                    </select>
                </div>

                <button type="submit" class="join-btn" id="joinBtn">
                    <span class="btn-icon">‚Üí</span>
                    <span id="joinBtnText">–î–∞–ª—ñ</span>
                </button>
            </form>

            <!-- Step 2: Device Selection -->
            <div id="deviceSetup" style="display: none;">
                <h2 style="font-size: 20px; margin-bottom: 20px;">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤</h2>

                <!-- Video Preview -->
                <div style="margin-bottom: 20px;">
                    <video id="previewVideo" autoplay playsinline muted style="width: 100%; border-radius: 12px; background: #1e293b; max-height: 300px;"></video>
                </div>

                <!-- Camera Selection -->
                <div class="input-group">
                    <label for="cameraSelect">
                        <span>üìπ</span> –ö–∞–º–µ—Ä–∞ / Camera
                    </label>
                    <select id="cameraSelect" class="language-select">
                        <option value="">Loading cameras...</option>
                    </select>
                    <label style="display: flex; align-items: center; margin-top: 8px; cursor: pointer;">
                        <input type="checkbox" id="enableVideo" checked style="margin-right: 8px;">
                        <span>–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É / Enable camera</span>
                    </label>
                </div>

                <!-- Microphone Selection -->
                <div class="input-group">
                    <label for="microphoneSelect">
                        <span>üé§</span> –ú—ñ–∫—Ä–æ—Ñ–æ–Ω / Microphone
                    </label>
                    <select id="microphoneSelect" class="language-select">
                        <option value="">Loading microphones...</option>
                    </select>
                    <label style="display: flex; align-items: center; margin-top: 8px; cursor: pointer;">
                        <input type="checkbox" id="enableAudio" checked style="margin-right: 8px;">
                        <span>–£–≤—ñ–º–∫–Ω—É—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω / Enable microphone</span>
                    </label>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button type="button" class="join-btn" id="backBtn" style="flex: 1; background: #475569;">
                        <span>‚Üê –ù–∞–∑–∞–¥</span>
                    </button>
                    <button type="button" class="join-btn" id="continueBtn" style="flex: 2;">
                        <span class="btn-icon">‚Üí</span>
                        <span>–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –¥–∑–≤—ñ–Ω–∫–∞</span>
                    </button>
                </div>
            </div>

            <p class="privacy-note">
                <span class="icon">üîí</span>
                Your video and audio will only be visible to meeting participants
            </p>
        </div>
    </div>

    <!-- Modular Guest Logic -->
    <script type="module">
        import { MediaManager } from '/static/js/webrtc/media-manager.js';
        import { sessionStore } from '/static/js/core/storage.js';
        import { loggers } from '/static/js/core/logger.js';

        const logger = loggers.guest;

        // DOM Elements
        const guestForm = document.getElementById('guestForm');
        const deviceSetup = document.getElementById('deviceSetup');
        const guestNameInput = document.getElementById('guestName');
        const languageSelect = document.getElementById('languageSelect');
        const joinBtnText = document.getElementById('joinBtnText');
        const backBtn = document.getElementById('backBtn');
        const continueBtn = document.getElementById('continueBtn');

        const previewVideo = document.getElementById('previewVideo');
        const cameraSelect = document.getElementById('cameraSelect');
        const microphoneSelect = document.getElementById('microphoneSelect');
        const enableVideo = document.getElementById('enableVideo');
        const enableAudio = document.getElementById('enableAudio');

        // Media manager
        let mediaManager = null;
        let previewStream = null;

        // Get room ID from URL
        function getRoomIDFromURL() {
            const path = window.location.pathname;
            const match = path.match(/\/join\/([^\/]+)/);
            return match ? match[1] : null;
        }

        const roomID = getRoomIDFromURL();
        if (!roomID) {
            logger.error('No room ID found in URL');
            alert('Invalid meeting link');
        }

        // Language switching
        languageSelect.addEventListener('change', (e) => {
            const lang = e.target.value;
            if (lang === 'uk') {
                joinBtnText.textContent = '–î–∞–ª—ñ';
                guestNameInput.placeholder = '–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º\'—è';
            } else {
                joinBtnText.textContent = 'Next';
                guestNameInput.placeholder = 'Enter your name';
            }
        });

        // Step 1: Name form submission
        guestForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const guestName = guestNameInput.value.trim();
            if (!guestName) {
                alert('Please enter your name');
                return;
            }

            logger.log('Guest name:', guestName);

            // Save to session
            sessionStore.set('guestName', guestName);
            sessionStore.set('isHost', false);
            sessionStore.set('language', languageSelect.value);

            // Show device setup
            guestForm.style.display = 'none';
            deviceSetup.style.display = 'block';

            // Initialize devices
            await initializeDevices();
        });

        // Back button
        backBtn.addEventListener('click', () => {
            // Stop preview stream
            if (previewStream) {
                previewStream.getTracks().forEach(track => track.stop());
                previewStream = null;
            }

            // Show form again
            deviceSetup.style.display = 'none';
            guestForm.style.display = 'block';
        });

        // Initialize device selection
        async function initializeDevices() {
            try {
                logger.log('Initializing media devices...');

                mediaManager = new MediaManager();

                // Request permissions first
                const tempStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                // Show preview
                previewStream = tempStream;
                previewVideo.srcObject = tempStream;

                // Get devices
                const devices = await mediaManager.enumerateDevices();

                logger.log(`Found ${devices.cameras.length} cameras, ${devices.microphones.length} microphones`);

                // Populate camera dropdown
                cameraSelect.innerHTML = '';
                devices.cameras.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });

                // Populate microphone dropdown
                microphoneSelect.innerHTML = '';
                devices.microphones.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `Microphone ${index + 1}`;
                    microphoneSelect.appendChild(option);
                });

                // Set current devices as selected
                const videoTrack = tempStream.getVideoTracks()[0];
                const audioTrack = tempStream.getAudioTracks()[0];

                if (videoTrack) {
                    cameraSelect.value = videoTrack.getSettings().deviceId;
                }

                if (audioTrack) {
                    microphoneSelect.value = audioTrack.getSettings().deviceId;
                }

                logger.success('Devices initialized');

            } catch (error) {
                logger.error('Failed to initialize devices:', error);
                alert(`Failed to access camera/microphone: ${error.message}\n\nPlease allow camera and microphone access.`);
            }
        }

        // Device change handlers
        cameraSelect.addEventListener('change', async (e) => {
            if (!previewStream) return;

            try {
                const deviceId = e.target.value;
                logger.log('Switching to camera:', deviceId);

                // Stop current video track
                const videoTrack = previewStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.stop();
                    previewStream.removeTrack(videoTrack);
                }

                // Get new video track
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: deviceId } }
                });

                const newVideoTrack = newStream.getVideoTracks()[0];
                previewStream.addTrack(newVideoTrack);

                previewVideo.srcObject = previewStream;

                logger.success('Camera switched');

            } catch (error) {
                logger.error('Failed to switch camera:', error);
            }
        });

        microphoneSelect.addEventListener('change', async (e) => {
            if (!previewStream) return;

            try {
                const deviceId = e.target.value;
                logger.log('Switching to microphone:', deviceId);

                // Stop current audio track
                const audioTrack = previewStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.stop();
                    previewStream.removeTrack(audioTrack);
                }

                // Get new audio track
                const newStream = await navigator.mediaDevices.getUserMedia({
                    audio: { deviceId: { exact: deviceId } }
                });

                const newAudioTrack = newStream.getAudioTracks()[0];
                previewStream.addTrack(newAudioTrack);

                logger.success('Microphone switched');

            } catch (error) {
                logger.error('Failed to switch microphone:', error);
            }
        });

        // Video/Audio toggle
        enableVideo.addEventListener('change', (e) => {
            if (previewStream) {
                const videoTrack = previewStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = e.target.checked;
                    previewVideo.style.opacity = e.target.checked ? '1' : '0.3';
                }
            }
        });

        enableAudio.addEventListener('change', (e) => {
            if (previewStream) {
                const audioTrack = previewStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = e.target.checked;
                }
            }
        });

        // Continue to meeting
        continueBtn.addEventListener('click', () => {
            // Save preferences
            sessionStore.set('cameraId', cameraSelect.value);
            sessionStore.set('microphoneId', microphoneSelect.value);
            sessionStore.set('enableVideo', enableVideo.checked);
            sessionStore.set('enableAudio', enableAudio.checked);

            logger.log('Joining meeting with settings:', {
                camera: cameraSelect.value,
                microphone: microphoneSelect.value,
                video: enableVideo.checked,
                audio: enableAudio.checked
            });

            // Stop preview stream
            if (previewStream) {
                previewStream.getTracks().forEach(track => track.stop());
            }

            // Redirect to modular call page
            window.location.href = `/room-modular/${roomID}`;
        });

        // Load host name from meeting info
        async function loadMeetingInfo() {
            try {
                const response = await fetch(`/api/meeting/${roomID}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.host_name) {
                        document.getElementById('hostName').textContent = data.host_name;
                    }
                }
            } catch (error) {
                logger.warn('Failed to load meeting info:', error);
            }
        }

        loadMeetingInfo();
    </script>
</body>
</html>
